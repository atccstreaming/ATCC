---
import Container from './Container.astro';
import { getSite } from '../content/site';
import { getLocaleFromPathname, stripBasePath, withBasePath, withLocale, type Locale } from '../i18n';

const current = Astro.url.pathname;
const currentPath = stripBasePath(current);
const locale: Locale = getLocaleFromPathname(current);
const site = getSite(locale);

const nav =
  locale === 'en'
    ? [
        { href: '/en', label: 'Home' },
        { href: '/en/about', label: 'About' },
        { href: '/en/visit', label: 'Visit' },
        { href: '/en/sermons', label: 'Sermons' },
        { href: '/en/events', label: 'Events' },
        { href: '/en/ministries', label: 'Ministries' },
        { href: '/en/give', label: 'Give' },
        { href: '/en/contact', label: 'Contact' }
      ]
    : [
        { href: '/', label: '首页' },
        { href: '/about', label: '关于我们' },
        { href: '/visit', label: '聚会信息' },
        { href: '/sermons', label: '讲道' },
        { href: '/events', label: '活动' },
        { href: '/ministries', label: '事工' },
        { href: '/give', label: '奉献' },
        { href: '/contact', label: '联系' }
      ];

const switchTo = locale === 'en' ? 'zh' : 'en';
const switchHref = withLocale(current, switchTo);
---
<header class="sticky top-0 z-50 border-b border-black/5 bg-parchment-50/80 backdrop-blur">
  <Container class="py-4">
    <div class="flex items-center justify-between gap-4">
      <a href={withBasePath(locale === 'en' ? '/en' : '/')} class="group flex items-baseline gap-2">
        <span class="font-serif text-lg tracking-wide text-ink-950">{site.name}</span>
        <span class="hidden text-xs text-ink-800/70 sm:inline">{site.nameEn}</span>
      </a>

      <details class="relative md:hidden">
        <summary
          class="list-none rounded-full border border-black/10 bg-white/40 px-3 py-2 text-sm font-medium text-ink-950 transition hover:bg-white/70"
          aria-label={locale === 'en' ? 'Open menu' : '打开菜单'}
        >
          {locale === 'en' ? 'Menu' : '菜单'}
        </summary>
        <div class="absolute left-1/2 mt-2 w-52 max-w-[calc(100vw-2rem)] -translate-x-1/2 overflow-hidden rounded-2xl border border-black/10 bg-white/95 shadow-soft backdrop-blur">
          <nav class="flex flex-col p-2">
            {nav.map((item) => {
              const active = currentPath === item.href;
              return (
                <a
                  href={withBasePath(item.href)}
                  class:list={[
                    'rounded-xl px-3 py-2 text-sm transition',
                    active ? 'bg-ink-950 text-parchment-50' : 'text-ink-900/80 hover:bg-black/5 hover:text-ink-950'
                  ]}
                >
                  {item.label}
                </a>
              );
            })}
            <div class="my-1 border-t border-black/10" />
            <a
              href={withBasePath(switchHref)}
              class="rounded-xl px-3 py-2 text-sm font-medium text-ink-950/90 transition hover:bg-black/5"
            >
              {locale === 'en' ? '中文' : 'EN'}
            </a>
            <a
              href={withBasePath(locale === 'en' ? '/en/visit' : '/visit')}
              class="rounded-xl bg-cinnabar-500 px-3 py-2 text-sm font-medium text-white shadow-soft transition hover:bg-cinnabar-600"
            >
              {locale === 'en' ? 'Plan a Visit' : '欢迎来访'}
            </a>
          </nav>
        </div>
      </details>

      <nav class="hidden items-center gap-1 md:flex">
        {nav.map((item) => {
          const active = currentPath === item.href;
          return (
            <a
              href={withBasePath(item.href)}
              class:list={[
                'rounded-full px-3 py-2 text-sm transition',
                active
                  ? 'bg-ink-950 text-parchment-50 shadow-soft'
                  : 'text-ink-900/80 hover:bg-black/5 hover:text-ink-950'
              ]}
            >
              {item.label}
            </a>
          );
        })}
      </nav>

      <div class="flex items-center gap-2">
        <a
          href={withBasePath(switchHref)}
          class="rounded-full border border-black/10 bg-white/40 px-3 py-2 text-sm font-medium text-ink-950 transition hover:bg-white/70"
          aria-label="Switch language"
        >
          {locale === 'en' ? '中文' : 'EN'}
        </a>

        <a
          href={withBasePath(locale === 'en' ? '/en/visit' : '/visit')}
          class="rounded-full bg-cinnabar-500 px-4 py-2 text-sm font-medium text-white shadow-soft transition hover:bg-cinnabar-600"
        >
          {locale === 'en' ? 'Plan a Visit' : '欢迎来访'}
        </a>
      </div>
    </div>
  </Container>
</header>
